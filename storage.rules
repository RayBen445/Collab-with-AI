rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Users can upload files to their own folder
    match /users/{userId}/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Project files - project members can access
    match /projects/{projectId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        (getUserData(request.auth.uid).projects[projectId] != null ||
         request.auth.token.email == 'oladoyeheritage445@gmail.com');
    }
    
    // Shared files - authenticated users can read
    match /shared/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        request.auth.token.email == 'oladoyeheritage445@gmail.com';
    }
    
    // Temp uploads - users can upload to temp folder
    match /temp/{userId}/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
  
  // Helper function to get user data
  function getUserData(uid) {
    return get(/databases/(default)/documents/users/$(uid)).data;
  }
}